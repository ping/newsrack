<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="referrer" content="same-origin"/>
    <meta name="robots" content="noindex"/>
    <meta name="description" content="An online newsrack of periodicals for your ereader">
    <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
    <title>Reader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha256-wLz3iY/cO4e6vKZ4zRmo4+9XDpMcgKOvv/zEU3OMlRo=" crossorigin="anonymous">
    <link rel="stylesheet" href="reader.css">
</head>
<body>
<main class="container-fluid">
    <div id="loading-container" class="d-flex justify-content-center">
        <div class="spinner-border text-primary m-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="display-container" class="d-flex justify-content-between gap-2">
        <div class="pagination-container fs-1">
            <a id="prev" href="#prev"
               class="d-flex position-absolute align-items-center justify-content-center top-0 bottom-0">
                <svg>
                    <use href="reader_sprites.svg#icon-chevron-left"></use>
                </svg>
            </a>
        </div>
        <div id="centre-container" class="flex-grow-1">
            <div id="toc-container" class="d-flex gap-1">
                    <span class="align-self-center">
                        <a href="./" class="home mx-1 fs-2">
                            <svg><use href="reader_sprites.svg#icon-home"></use></svg>
                        </a>
                    </span>
                <select id="toc" class="my-1 form-select form-select-sm"></select>
            </div>
            <div id="epub-container" class="h-100 mx-auto shadow">
            </div>
        </div>
        <div class="pagination-container fs-1">
            <a id="next" href="#next"
               class="d-flex position-absolute align-items-center justify-content-center top-0 bottom-0">
                <svg>
                    <use href="reader_sprites.svg#icon-chevron-right"></use>
                </svg>
            </a>
        </div>
    </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"
        integrity="sha256-rMfkFFWoB2W1/Zx+4bgHim0WC7vKRVrq6FTeZclH1Z4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"
        integrity="sha256-BurhV0UQe0qlCMlVOCdSUfab+58RdWIfxFjZ9C7QgtQ=" crossorigin="anonymous"></script>
<script>
    const params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
    const url = params && params.get("url") && decodeURIComponent(params.get("url"));
    const currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;
    let validBook;
    try {
        new URL(url);
        validBook = false;
    } catch (e) {
        validBook = true;
    }
    const loadingContainer = document.getElementById("loading-container");
    const displayContainer = document.getElementById("display-container");
    displayContainer.classList.add("d-none");

    if (!validBook) {
        if (loadingContainer) {
            loadingContainer.remove();
        }
        alert("Remote books not allowed.");
    } else {
        const book = ePub(url);
        const rendition = book.renderTo(
            "epub-container",
            {width: "100%", height: "100%", snap: true, manager: "continuous"}
        );
        rendition.display(currentSectionIndex);

        book.ready.then(function () {
            if (loadingContainer) {
                loadingContainer.remove();
            }
            displayContainer.classList.remove("d-none");
            const next = document.getElementById("next");
            next.addEventListener("click", function (e) {
                book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                e.preventDefault();
            }, false);

            const prev = document.getElementById("prev");
            prev.addEventListener("click", function (e) {
                book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                e.preventDefault();
            }, false);

            const keyListener = function (e) {
                // Left Key
                if ((e.keyCode || e.which) == 37) {
                    book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                }
                // Right Key
                if ((e.keyCode || e.which) == 39) {
                    book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                }
            };
            rendition.on("keyup", keyListener);
            document.addEventListener("keyup", keyListener, false);
        });

        window.addEventListener("unload", function () {
            this.book.destroy();
        });

        book.loaded.navigation.then(function (toc) {
            const $select = document.getElementById("toc");
            const docfrag = document.createDocumentFragment();

            toc.forEach(function (chapter) {
                const option = document.createElement("option");
                option.textContent = chapter.label;
                option.setAttribute("ref", chapter.href);
                docfrag.appendChild(option);
                chapter.subitems.forEach(function (subitem) {
                    const subOption = document.createElement("option");
                    subOption.textContent = "* " + subitem.label;
                    subOption.setAttribute("ref", subitem.href);
                    docfrag.appendChild(subOption);
                    subitem.subitems.forEach(function (sub2item) {
                        const sub2Option = document.createElement("option");
                        sub2Option.textContent = "--- " + sub2item.label;
                        sub2Option.setAttribute("ref", sub2item.href);
                        docfrag.appendChild(sub2Option);
                    });
                });
            });

            $select.appendChild(docfrag);

            $select.onchange = function () {
                const index = $select.selectedIndex;
                const url = $select.options[index].getAttribute("ref");
                rendition.display(url);
                return false;
            };

        });

        book.loaded.metadata.then(function (meta) {
            document.title = meta.title;
        });

        rendition.on("relocated", function (location) {
            const $select = document.getElementById("toc");
            const $selected = $select.querySelector("option[selected]");
            if ($selected) {
                $selected.removeAttribute("selected");
            }

            const $options = $select.querySelectorAll("option");
            for (let i = 0; i < $options.length; ++i) {
                let selected = $options[i].getAttribute("ref") === location.start.href;
                if (selected) {
                    $options[i].setAttribute("selected", "");
                }
            }

            const next = book.package.metadata.direction === "rtl" ? document.getElementById("prev") : document.getElementById("next");
            const prev = book.package.metadata.direction === "rtl" ? document.getElementById("next") : document.getElementById("prev");

            if (location.atEnd) {
                next.style.visibility = "hidden";
            } else {
                next.style.visibility = "visible";
            }

            if (location.atStart) {
                prev.style.visibility = "hidden";
            } else {
                prev.style.visibility = "visible";
            }

        });

        rendition.themes.register("viewer-theme", "viewer-theme.css");
        rendition.themes.select("viewer-theme");
    }
</script>
</body>
</html>